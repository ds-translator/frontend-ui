name: Backend CI/CD Pipeline

on:
  push:
    branches: 
      - main
      - develop

permissions:
  contents: read
  packages: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

  build-and-push-image:
    if: github.ref == 'refs/heads/main'
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history and tags        

      - name: 'Login to GitHub Container Registry'
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Set Image Name and Git Tag
        run: |
          echo "IMAGE_NAME=ghcr.io/ds-translator/frontend-ui" >> $GITHUB_ENV
          # Extract the tag from the Git ref, e.g. refs/tags/v1.0.0 becomes v1.0.0
          TAG=$(git describe --tags --abbrev=0)

          echo "IMAGE_TAG=${TAG}" >> $GITHUB_ENV
          echo "Building image with tag: ${{ env.IMAGE_TAG }} and latest"

      - name: Build Docker Image with Git Tag and latest Tag
        run: docker build . --file Dockerfile --tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} --tag ${{ env.IMAGE_NAME }}:latest

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: "json"
          output: "trivy-report.json"
          severity: "CRITICAL,HIGH"

      - name: Push Images to GHCR
        run: |
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_NAME }}:latest
